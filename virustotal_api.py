import requests
import json

# mziv's api key:
apikey = '39c27871dcf2ffdf90c0b961070156afa19673350d263c14175a44a7b11e19c0'

# view stats at: https://www.virustotal.com/gui/user/mziv/apikey

# not working :(
def get_quotas():
	url_quotas = 'https://www.virustotal.com/api/v3/users/'
	headers = {'x-apikey': apikey}

	response = requests.get(url_quotas + apikey, headers=headers)
	response_json = json.loads(response.text)
	quotas = response_json['data']['attributes']['quotas']
	print(quotas)
	return quotas

def within_quotas(quotas):
	for k in quotas:
		if quotas[k]['used'] >= quotas[k]['allowed'] and quotas[k]['allowed'] > 0:
			return False

	return True

def print_nonzero_quotas(quotas):
	for k in quotas:
		if quotas[k]['used'] > 0:
			print("used: ", quotas[k]['used'], " allowed: ", quotas[k]['allowed'])

'''
Uploads a file to be scanned by Virustotal.
Returns the resource ID for this file.
'''
def post_file(file):
	url = 'https://www.virustotal.com/vtapi/v2/file/scan'
	params = {'apikey': apikey}
	# TODO: decide file formatting
	files = {'file': (file, open(file, 'rb'))}
	response = requests.post(url, files=files, params=params)
	response_json = json.loads(response.text)
	link = response_json['resource']
	return link

'''
Given a resource token, gets the stats for that file.
Input from post_file can be passed into this function.
'''
def check_file(resource):
	url_file_req = 'https://www.virustotal.com/vtapi/v2/file/report'
	params = {'apikey': apikey, 'resource': resource}
	response = requests.get(url_file_req, params=params)
	return response.json()


badfile = 'C:\\Users\\peace\\Documents\\GitHub\\itchingtofindsomemalware\\Files\\mimic.zip'

testfile = 'C:\\Users\\peace\\Documents\\GitHub\\itchingtofindsomemalware\\itch_extract\\text\\descend\\rustup-init.exe'
# print("Fetching quotas.")
# quotas = get_quotas()
# print_nonzero_quotas(quotas)


# print("Posting file.")
# resource = post_file(testfile)
# print(resource)

# filestats = check_file(resource)
# print(filestats)


# if (within_quotas(quotas)):
# 	print(check_file('e8bf0004af0266b99d272ea0e1588504c99e695dab5e3ff732e95935f9212930'))

# print(response.json())
# print(response_json['quotas'])